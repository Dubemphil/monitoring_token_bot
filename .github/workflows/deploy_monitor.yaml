name: 'Deploy Enhanced Solana Monitor (Python) with Load Balancing'

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: "solana_monitor_bot_python"
  DOCKER_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Python Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
        platforms: linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy Python Monitor Bot to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        port: ${{ secrets.EC2_PORT }}
        script: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          
          # Docker login
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

          # Stop and remove existing container
          docker stop solana_monitor_python 2>/dev/null || true
          docker rm solana_monitor_python 2>/dev/null || true

          # Remove old image
          docker rmi ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest 2>/dev/null || true

          # Pull latest image
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest

          # Create credentials.json from secret
          echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" | base64 -d > /home/${{ secrets.EC2_USER }}/credentials.json
          
          # Verify credentials
          if [ ! -f /home/${{ secrets.EC2_USER }}/credentials.json ]; then
            echo "‚ùå Failed to create credentials.json"
            exit 1
          fi

          # Create logs directory structure
          mkdir -p /home/${{ secrets.EC2_USER }}/logs
          touch /home/${{ secrets.EC2_USER }}/logs/enhanced-monitor.log
          touch /home/${{ secrets.EC2_USER }}/logs/rpc-balancer.log
          touch /home/${{ secrets.EC2_USER }}/logs/webhook-activity.log
          touch /home/${{ secrets.EC2_USER }}/logs/price-cache.log
          touch /home/${{ secrets.EC2_USER }}/logs/stop-loss-tracking.log

          # Run Python monitoring container
          docker run -d \
            --name solana_monitor_python \
            --restart unless-stopped \
            --dns 8.8.8.8 \
            --dns 1.1.1.1 \
            -p 8080:8080 \
            -e SPREADSHEET_ID="${{ secrets.SPREADSHEET_ID }}" \
            -e SHEET_NAME="SolanaMonitoring" \
            -e HELIUS_RPC_URLS="${{ secrets.HELIUS_RPC_URL_1 }},${{ secrets.HELIUS_RPC_URL_2 }},${{ secrets.HELIUS_RPC_URL_3 }},${{ secrets.HELIUS_RPC_URL_4 }},${{ secrets.HELIUS_RPC_URL_5 }}" \
            -e TICK_INTERVAL_SECONDS="8" \
            -e MONITORING_DURATION_HOURS="24" \
            -e USDC_TOKEN_ADDRESS="${{ secrets.USDC_TOKEN_ADDRESS }}" \
            -e SLIPPAGE_BPS="100" \
            -e RATE_LIMIT_MS="200" \
            -e WEBHOOK_PORT="8080" \
            -e ENABLE_WEBHOOKS="true" \
            -e ENABLE_DETAILED_LOGGING="true" \
            -v /home/${{ secrets.EC2_USER }}/credentials.json:/app/credentials.json:ro \
            -v /home/${{ secrets.EC2_USER }}/logs:/app/logs \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest

          # Wait for container to start
          sleep 20

          # Check container status
          if docker ps | grep -q solana_monitor_python; then
            echo "‚úÖ Python Monitor container is running"
            docker logs solana_monitor_python --tail 30
            
            # Test webhook endpoint
            curl -f http://localhost:8080/health || echo "‚ö†Ô∏è Webhook endpoint not responding yet"
            
            # Set up log monitoring script
            cat > /home/${{ secrets.EC2_USER }}/monitor_logs.sh << 'LOGSCRIPT'
          #!/bin/bash
          
          docker logs solana_monitor_python --follow --tail 0 2>&1 | while read line; do
            echo "$line" >> /home/${{ secrets.EC2_USER }}/logs/enhanced-monitor.log
            
            # Track RPC activity
            if echo "$line" | grep -qi "rpc\|balancer\|rate.*limit"; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') $line" >> /home/${{ secrets.EC2_USER }}/logs/rpc-balancer.log
            fi
            
            # Track webhook activity
            if echo "$line" | grep -qi "webhook\|cached\|üì°"; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') $line" >> /home/${{ secrets.EC2_USER }}/logs/webhook-activity.log
            fi
            
            # Track price cache
            if echo "$line" | grep -qi "cache\|üîÑ"; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') $line" >> /home/${{ secrets.EC2_USER }}/logs/price-cache.log
            fi
            
            # Track stop-loss events
            if echo "$line" | grep -qi "stop-loss\|üõë\|trailing"; then
              echo "$(date '+%Y-%m-%d %H:%M:%S') $line" >> /home/${{ secrets.EC2_USER }}/logs/stop-loss-tracking.log
            fi
          done &
          LOGSCRIPT
            
            chmod +x /home/${{ secrets.EC2_USER }}/monitor_logs.sh
            nohup /home/${{ secrets.EC2_USER }}/monitor_logs.sh > /dev/null 2>&1 &
            
            echo ""
            echo "üìã Log Monitoring Commands:"
            echo "   View all logs: docker logs -f solana_monitor_python"
            echo "   View main log: tail -f /home/${{ secrets.EC2_USER }}/logs/enhanced-monitor.log"
            echo "   View RPC log: tail -f /home/${{ secrets.EC2_USER }}/logs/rpc-balancer.log"
            echo "   View webhook log: tail -f /home/${{ secrets.EC2_USER }}/logs/webhook-activity.log"
            echo "   View stop-loss log: tail -f /home/${{ secrets.EC2_USER }}/logs/stop-loss-tracking.log"
            echo ""
            
          else
            echo "‚ùå Python Monitor container failed to start"
            docker logs solana_monitor_python --tail 50 || true
            exit 1
          fi

          # Save deployment logs
          docker logs solana_monitor_python --tail 100 > /home/${{ secrets.EC2_USER }}/logs/deploy-$TIMESTAMP.txt 2>&1 || true
          
          # Test health endpoint
          sleep 5
          if curl -s http://localhost:8080/health | grep -q "healthy"; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è Health check failed - but continuing"
          fi
          
          # Logout from Docker Hub
          docker logout

          echo "‚úÖ Python Solana Monitor Bot deployed successfully!"
          echo ""
          echo "üìä Monitoring Information:"
          echo "   - Container name: solana_monitor_python"
          echo "   - RPC Load Balancing: 5 endpoints"
          echo "   - Webhook server: http://localhost:8080"
          echo "   - Health check: http://localhost:8080/health"
          echo ""
          echo "üìã Useful Commands:"
          echo "   docker logs -f solana_monitor_python              # Live logs"
          echo "   docker logs solana_monitor_python --tail 100      # Last 100 lines"
          echo "   docker stats solana_monitor_python                # Resource usage"
          echo "   docker exec -it solana_monitor_python /bin/sh    # Shell access"
          echo "   docker restart solana_monitor_python              # Restart container"
          echo ""